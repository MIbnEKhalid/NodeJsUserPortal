<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <title>Login</title>
        <script src="/Assets/Scripts/logout.js"></script>
        <style>
            .info {
                font-family: 'Open Sans', sans-serif;
                font-size: 14px;
                color: #0c5460;
                background-color: #d1ecf1;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 10px 5px;
                margin-top: 5px;
                font-weight: 500;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                line-height: 1.2;
            }
            .info span {
                color: #007bff; /* Highlight for the info icon */
                margin-right: 8px;
            }
            section .button {
                margin: 0 0 2px !important;
            }
            section .button button {
                margin: 0 !important;
            }
            .back {
                top: 0;
                color: #fff;
                position: absolute;
                margin-top: 10px;
                font-size: 20px;
                transition: color 0.3s ease;
            }
            .back:hover {
                color: rgb(185, 185, 185);
                transition: color 0.3s ease;
            }
        </style>
    </head>
    {% include "../templates/header1.njk" %}
    <body>
        <section class="about" id="about">
            <div class="content">
                <div class="portalbox">
                    <div class="title">
                        <span style="font-size:30px;">Login Portal</span>
                    </div>
                    <form id="loginForm" action="/login" method="POST">
                        <div class="back" onclick="loadpage('/')">
                            <i class="fa-solid fa-arrow-left"></i>
                        </div>
                        <div class="user-box">
                            <input
                                id="loginUsername"
                                type="text"
                                name="username"
                                required
                                pattern="^[a-z0-9.]+$"
                                title="Username must contain lowercase letters, numbers, and periods only, no spaces, no special characters."
                                oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9.]/g, '')"/>
                            <label>User Name</label>
                            <span class="info-icon" onclick="usernameinfo()">
                                <i class="fas fa-info-circle"></i>
                            </span>
                        </div>
                        <div class="user-box">
                            <input id="loginPassword" type="password" name="Password" required=""/>
                            <label>Password</label>
                            <span class="password-toggle-icon">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                        <div class="wrap">
                            <div class="button">
                                <button style="font-size: 17px;" type="submit">Login</button>
                            </div>
                        </div>
                        {% if userLoggedIn === true %}
                            {% include "../notice/alreadyloggedin.njk" %}
                        {% endif %}
                        <p class="info">
                            <span class="">
                                <i class="fas fa-info-circle"></i>
                            </span>By Logging In, You Are Automatically Agreeing To Our
                            <a class="links" href="/Terms&Conditions">Use Of Terms & Conditions
                            </a>
                        </p>
                    </form>
                    <div style="display: none" class="checkbox-container">
                        <label class="lns-checkbox">
                            <input type="checkbox" id="rememberMe">
                            <span>Remember Me</span>
                        </label>
                    </div>
                </div>
            </div>
        </section>
    </body>
    {% include "../script/showmessage.njk" %}
    <script>
        function usernameinfo() {
            showMessage(
                '<div style="">If you are a member of the Mbk Tech Studio team, your username is the first part of your email address (e.' +
                        'g., for abc.xyz@mbktechstudio.com, your username is abc.xyz). If you are a guest or have forgotten your username and pas' +
                        'sword, please fill contact form at <a class="links" href="https://www.mbktechstudio.com/Support">mbktechstudio.com/Suppo' +
                        'rt</a> or contact me directly.<div>',
                "What Is My Username?"
            );
        }
        /* document.addEventListener('DOMContentLoaded', () => {
    const rememberMeCheckbox = document.getElementById('rememberMe');
    const usernameInput = document.getElementById('loginUsername');
    // Load saved username if "Remember Me" was checked
    if (localStorage.getItem('rememberMe') === 'true') {
   rememberMeCheckbox.checked = true; usernameInput.value = localStorage.getItem('savedUsername') || '';
    }
    // Save username if "Remember Me" is checked
    document.getElementById('loginForm').addEventListener('submit', () => {
   if (rememberMeCheckbox.checked) {
    localStorage.setItem('rememberMe', 'true');
    localStorage.setItem('savedUsername', usernameInput.value);
   } else {
    localStorage.removeItem('rememberMe');
    localStorage.removeItem('savedUsername');
   }
    });
   }); */
        document.getElementById('loginForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const username = document
                .getElementById('loginUsername')
                .value
                .trim();
            const password = document
                .getElementById('loginPassword')
                .value
                .trim();
            if (! username || ! password) {
                showMessage("Username and password cannot be empty", "Error");
                return;
            }
            const loginButton = document.querySelector('button[type="submit"]');
            loginButton.disabled = true;
            loginButton.innerText = "Logging in.....";
            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(
                {username, password})
            })
                .then(response => {
                    loginButton.disabled = false;
                    loginButton.innerText = "Login";
                    return response.json().then(data => {
                        if (response.ok) {
                            return data; // Resolve with the data if the response is OK
                        } else {
                            throw new Error(data.message || "An error occurred");
                        }
                    });
                })
                .then(data => {
                    if (data.success) {
                        sessionStorage.setItem('sessionId', data.sessionId);
                        clearAllCookies();
                        const redirectUrl = new URLSearchParams(window.location.search).get('redirect');
                        loginButton.innerText = "Redirecting.....";
                        window.location.href = redirectUrl
                            ? decodeURIComponent(redirectUrl)
                            : '/home';
                    } else {
                        showMessage(data.message, "Error");
                        document.getElementById('loginMessage').innerText = data.message;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage(error.message, "Error");
                    loginButton.disabled = false;
                    loginButton.innerText = "Login";
                });
        });
        document.addEventListener('DOMContentLoaded', function () {
            const loginButton = document.querySelector('button[type="submit"]');
            loginButton.innerText = "Login";
        });
        // Event listener for toggling password visibility
        document.addEventListener('DOMContentLoaded', function () { // Set the value of the input field with the page URL
            const passwordInput = document.getElementById('loginPassword');
            const toggleIcon = document.querySelector('.password-toggle-icon');
            toggleIcon.addEventListener('click', function () { // Toggle the type of the input field
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text'; // Show password
                    toggleIcon.innerHTML = '<i class="fas fa-eye-slash"></i>'; // Change icon to closed eye
                } else {
                    passwordInput.type = 'password'; // Hide password
                    toggleIcon.innerHTML = '<i class="fas fa-eye"></i>'; // Change icon to open eye
                }
            });
        });
        const urlParams = new URLSearchParams(window.location.search);
        const usernameFromUrl = urlParams.get('username');
        const passwordFromUrl = urlParams.get('password');
        if (usernameFromUrl && !document.getElementById('loginUsername').value) {
            document.getElementById('loginUsername').value = usernameFromUrl;
        }
        if (passwordFromUrl && !document.getElementById('loginPassword').value) {
            document.getElementById('loginPassword').value = passwordFromUrl;
        }
    </script>
    {% include "../templates/footer.njk" %}
</html>